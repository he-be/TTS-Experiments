# SSH経由でのGradio利用と接続安定性について

現在、SSHポートフォワーディング経由でGradioをご利用とのことですが、接続の切断やUIのフリーズが発生する件について、対策と今後の指針をまとめました。

## 今回実施した即時対策

以下の2点をコードレベルで修正し、安定性と使用感を向上させました。

1.  **接続安定化 (`demo.queue()`の追加)**
    *   従来のコードでは `queue()` が有効化されていなかったため、ネットワークの瞬断や長時間処理のタイムアウトが発生しやすい状態でした。
    *   これを有効化したことで、ブラウザとサーバー間の通信がWebSocketで堅牢に管理され、SSH経由でも接続が維持されやすくなります。

2.  **UIフィードバック (`Regen`ボタン)**
    *   セグメント生成時に画面に変化がなく、処理中かどうかわからない問題を解消するため、`Regen`ボタンを押した際に画面上部にプログレスバー（標準のローディング表示）が出るように変更しました。

---

## SSH接続が頻繁に切れる場合の恒久的対策（今後の指針）

コード修正だけでは回避できない「物理的な回線切断」や「SSHセッションタイムアウト」への対策として、以下の方法を推奨します。

### 1. サーバープロセスの永続化 (`tmux` / `screen`)
SSHが切れてもPythonプロセス自体がダンプしないよう、`tmux` や `screen` を使用してサーバーを起動してください。
```bash
# tmuxの起動
tmux new -s tts_server

# サーバー起動
sh serve.sh

# デタッチ（SSHを切っても動き続ける）: Ctrl+B, D
```

### 2. SSH接続の安定化 (`ServerAliveInterval`)
SSHクライアント（手元のPC）の設定ファイル `~/.ssh/config` に以下のような設定を追加すると、無通信による切断を防げます。
```ssh
Host my-gpu-server
    HostName 192.168.x.x
    ServerAliveInterval 60
    ServerAliveCountMax 3
```

### 3. リバースプロキシツールの利用（推奨）
SSHポートフォワーディングは手軽ですが、不安定になりがちです。開発用途であれば、以下のようなツールを使うとHTTPSの公開URLが発行され、接続が圧倒的に安定します。

*   **ngrok**: `ngrok http 7860`
*   **Cloudflare Tunnel**: `cloudflared tunnel --url http://localhost:7860`
*   **Gradio Share**: 起動オプションに `--share` をつける（ただし72時間制限あり、今回コードにはオプション自体はあります）

今の修正でかなり改善するはずですが、もし頻発する場合は上記インフラ面の対策をご検討ください。
